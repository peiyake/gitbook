# 使用abrt监控程序coredump

> 在UNIX系统中，常将“主内存”(main memory) 称为核心(core)，因为在使用半导体作为内存材料之前，便是使用核心(core)。而核心映像(core image) 就是 “进程”(process)执行当时的内存内容。当进程发生错误或收到“信号”(signal) 而终止执行时，系统会将核心映像写入一个文件，以作为调试之用，这就是所谓的核心转储(core dump)。----来自 [百度百科-核心转储](https://baike.baidu.com/item/%E6%A0%B8%E5%BF%83%E8%BD%AC%E5%82%A8/16772089?fromtitle=core%20dump&fromid=2971395&fr=aladdin)

## 程序产生coredump的原因

1. 访问无效指针
   * 访问NULL指针
   * 直接使用没有初始化的指针
   * 对一个已经free的指针重复free（double free）
2. 指针越界
   * 申请内存长度为32，却memcpy了长度大于32的内容

3. 其它原因

## 使用abrt监控coredump

1. 安装abrt服务
   
   yum install abrt.x86_64

2. 安装abrt core-dump监控插件

   yum install abrt-addon-ccpp.x86_64

3. 启动abrt服务

    systemctl start abrtd

## 注意事项

1. 默认情况下，abrt-addon-ccpp只监控来自rpm包的应用程序产生的core-dump，如果你要使他能监控自己编写的应用程序，那么需要修改配置文件。修改方法：编辑`/etc/abrt/abrt-action-save-package-data.conf`，把`ProcessUnpackaged = no` 改成 `ProcessUnpackaged = yes`.

2. 另外，编辑 `/etc/abrt/abrt-action-save-package-data.conf ` 把 `OpenGPGCheck = yes` to `OpenGPGCheck = no`，使能 non-GPG 签名的程序

## core-dump举例

1. 编写如下应用程序

```c
#include <stdio.h>
#include <string.h>
int main(int argc,const char **argv)
{
        char *p = NULL;
        memcpy(p,"Hello,world",sizeof("Hello world"));
        printf("p = %s\n",p);
        return 0;
}
```

2. 编译、执行、查看coredump

```shell
[root@a ~]# gcc dump.c -o dump      # 编译生成 可执行文件 dump
[root@a ~]# ./dump                  # 运行dump
Segmentation fault (core dumped)
[root@a ~]# abrt-cli list           # 使用abrt-cli 查看abrt捕捉到的core-dump信息
id 3da5246b89c3112fa7eccd21d1ae363a8be44a09
reason:         dump killed by SIGSEGV
time:           Mon May 25 10:15:48 2020
cmdline:        ./dump
uid:            0 (root)
Directory:      /var/spool/abrt/ccpp-2020-05-25-10:15:48-28684

[root@a ~]# gdb ./dump /var/spool/abrt/ccpp-2020-05-25-10:15:48-28684/coredump  # 使用gdb查看core文件
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /root/dump...done.

warning: exec file is newer than core file.
[New LWP 28684]
Core was generated by `./dump'.
Program terminated with signal 11, Segmentation fault.
#0  0x00007f7748635667 in __memcpy_ssse3 () from /lib64/libc.so.6
Missing separate debuginfos, use: debuginfo-install glibc-2.17-222.el7.x86_64
(gdb) bt
#0  0x00007f7748635667 in __memcpy_ssse3 () from /lib64/libc.so.6
#1  0x00000000004005aa in main (argc=1, argv=0x7fff014aa9f8) at dump.c:6
(gdb) quitT ~]# gdb ./dump /var/spool/abrt/ccpp-2020-05-25-10:15:48-28684/coredump
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /root/dump...done.

warning: exec file is newer than core file.
[New LWP 28684]
Core was generated by `./dump'.
Program terminated with signal 11, Segmentation fault.
#0  0x00007f7748635667 in __memcpy_ssse3 () from /lib64/libc.so.6
Missing separate debuginfos, use: debuginfo-install glibc-2.17-222.el7.x86_64
(gdb) bt
#0  0x00007f7748635667 in __memcpy_ssse3 () from /lib64/libc.so.6
#1  0x00000000004005aa in main (argc=1, argv=0x7fff014aa9f8) at dump.c:6
(gdb) quit ~]# gdb ./dump /var/spool/abrt/ccpp-2020-05-25-10:15:48-28684/coredump
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /root/dump...done.

warning: exec file is newer than core file.
[New LWP 28684]
Core was generated by `./dump'.
Program terminated with signal 11, Segmentation fault.
#0  0x00007f7748635667 in __memcpy_ssse3 () from /lib64/libc.so.6
Missing separate debuginfos, use: debuginfo-install glibc-2.17-222.el7.x86_64
(gdb) bt
#0  0x00007f7748635667 in __memcpy_ssse3 () from /lib64/libc.so.6
#1  0x00000000004005aa in main (argc=1, argv=0x7fff014aa9f8) at dump.c:6    # 精准定位代码错误
(gdb) quit
```

