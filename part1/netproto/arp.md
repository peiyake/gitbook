# 地址解析协议

地址解析协议（英语：Address Resolution Protocol，缩写：ARP）是一个通过解析网络层地址来找寻数据链路层地址的网络传输协议，它在IPv4中极其重要。

_注意:本文概念性总结，均来自维基百科[ARP协议](https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE)上的文字介绍_

## 基本功能
>在以太网协议中规定，同一局域网中的一台主机要和另一台主机进行直接通信，必须要知道目标主机的MAC地址。而在TCP/IP协议中，网络层和传输层只关心目标主机的IP地址。这就导致在以太网中使用IP协议时，数据链路层的以太网协议接到上层IP协议提供的数据中，只包含目的主机的IP地址。于是需要一种方法，根据目的主机的IP地址，获得其MAC地址。这就是ARP协议要做的事情。所谓地址解析（address resolution）就是主机在发送帧前将目标IP地址转换成目标MAC地址的过程

## 数据包结构

1. 报文格式
   
![arp报文格式](images/arp.png)

2. 报文字段说明
   
* 硬件类型：如以太网（0x0001）、分组无线网。
* 协议类型：如网际协议(IP)（0x0800）、IPv6（0x86DD）。
* 硬件地址长度：每种硬件地址的字节长度，一般为6（以太网）。
* 协议地址长度：每种协议地址的字节长度，一般为4（IPv4）。
* 操作码：1为ARP请求，2为ARP应答，3为RARP请求，4为RARP应答。
* 源硬件地址：n个字节，n由硬件地址长度得到，一般为发送方MAC地址。
* 源协议地址：m个字节，m由协议地址长度得到，一般为发送方IP地址。
* 目标硬件地址：n个字节，n由硬件地址长度得到，一般为目标MAC地址。
* 目标协议地址：m个字节，m由协议地址长度得到，一般为目标IP地址。

## arp工作原理
以主机A（192.168.38.10）向主机B（192.168.38.11）发送数据为例。
>1.当发送数据时，主机A会在自己的ARP缓存表中寻找是否有目标IP地址。如果找到就知道目标MAC地址为（00-BB-00-62-C2-02），直接把目标MAC地址写入帧里面发送就可。

>2.如果在ARP缓存表中没有找到相对应的IP地址，主机A就会在网络上发送一个广播（ARP request），目标MAC地址是“FF.FF.FF.FF.FF.FF”，这表示向同一网段内的所有主机发出这样的询问：“192.168.38.11的MAC地址是什么？”

>3.网络上其他主机并不响应ARP询问，只有主机B接收到这个帧时，才向主机A做出这样的回应（ARP response）：“192.168.38.11的MAC地址是00-BB-00-62-C2-02”，此回应以单播方式。这样，主机A就知道主机B的MAC地址，它就可以向主机B发送信息。同时它还更新自己的ARP高速缓存（ARP cache），下次再向主机B发送信息时，直接从ARP缓存表里查找就可。 

## ARP代理

### 原理举例分析

例如如下组网模式：

![arp代理图](images/arp_proxy.png)

假设如下条件：
1. 主机A没有配置默认网关
2. 主机B没有配置默认网关
3. 网关开启ARP代理

那么，主机A 和 主机B不在同一个子网，又是如何通过ARP代理功能实现通信的呢？

1. 主机A想要和主机B通信，那么，主机A 192.168.1.0/24 首先会发起ARP request，目的MAC 全F，请求主机B的MAC地址
2. 如果网关没有开启ARP代理的话,那么网关收到主机A的ARP request后，是不会回应的。因为 网关作为路由设备，天生隔离广播包的。这种情况，主机A和主机B是无法通信的
3. 网关开启ARP代理后，网关收到ARP request后，会根据请求的的目的IP （也就是主机B的IP）来找网关自己的ARP缓存表，如果存在主机B的表项，那么网关会给主机A回复 ARP relay，此时会把网关
   自己的MAC地址填写到报文中
4. 这是主机A收到了 arp relay后，会认为获取到的MAC地址就是主机B的（实际上是网关的），主机A继续后续数据通信，向网关发送数据包
5. 网关收到数据包后，根据目的IP，再把数据包发送给主机B，这样主机A 和 主机B就实现了通信
6. 对于网关开启ARP代理后，虽然主机A/B不在同一子网，那么对两者来说网络是透明的，只不过两个子网间的通信需要经过网关来转发
7. 这种模式下，开启ARP 代理的网关事实上是承载了 “网关” 的功能

### ARP代理应用场景

1. 三层交换机开启ARP代理实现不同子网间的通信
2. 路由式ARP代理
   如上面例子分析的，当不同网段主机没有配置默认网关，且需要相互通信时，在中间路由器上开启ARP代理功能后，主机就可以通信了
3. VLAN内ARP代理
   VLAN开启用户隔离，vlan内的终端无法通信。只需要在该VALN上启用ARP代理即可
4. VLAN间ARP代理
   不同VLAN间终端无法通信，只需要在该VLAN的接口上开启ARP代理即可

## 免费ARP

免费ARP（gratuitous ARP），他是指主机发送ARP查询（广播）自己的IP地址，当ARP功能被开启或者是端口初始配置完成，主机向网络发送免费ARP来查询自己的IP地址确认地址唯一可用。

作用：
* 确定网络中是否有其他主机使用了IP地址，如果有应答则产生错误消息。
* 免费ARP可以做更新ARP缓存用，网络中的其他主机收到该广播则在缓存中更新条目，收到该广播的主机无论是否存在与IP地址相关的条目都会强制更新，如果存在旧条目则会将MAC更新为广播包中的MAC。

## ARP老化机制

ARP缓存表采用老化机制，在一段时间内如果表中的某一行没有使用，就会被删除，这样可减少缓存表的长度，加快查询速度。

1. ARP 老化时间间隔
```
    #centos系统上查看默认老化时间，单位：秒
    ~# cat /proc/sys/net/ipv4/neigh/default/gc_stale_time 
    60

    #注意：每个网络接口也会有单独的arp老化时间配置 执行 ls /proc/sys/net/ipv4/neigh/ 查看有哪些接口
```

   